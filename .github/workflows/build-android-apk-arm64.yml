name: Build and Release Android APK (ARM64)

# è¿è¡Œåç§°ç¤ºä¾‹: "1.0.1 Android ARM64 .apk"
run-name: ${{ github.ref_name }} Android ARM64 .apk

on:
  push:
    tags:
      - '[0-9]*' # ä»…åœ¨æ‰“ tag æ—¶è§¦å‘
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

jobs:
  build-android-apk:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: false
          tool-cache: false
          dotnet: true
          haskell: true
          swap-storage: true
          docker-images: true
          large-packages: true

      - name: ðŸ“¥ Checkout main repo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Checkout rwkv_mobile_flutter dependency
        uses: actions/checkout@v4
        with:
          repository: MollySophia/rwkv_mobile_flutter
          ref: dev
          path: rwkv_mobile_flutter
          fetch-depth: 1

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: ðŸ“ Generate Config Files
        run: |
          echo "::group::ðŸ”§ Configuring Dependencies & Env"
          echo "dependency_overrides:" > pubspec_overrides.yaml
          echo "  rwkv_mobile_flutter:" >> pubspec_overrides.yaml
          echo "    path: ./rwkv_mobile_flutter" >> pubspec_overrides.yaml
          echo "âœ… pubspec_overrides.yaml created"
          echo "::endgroup::"

      # âŒ å·²åˆ é™¤ "ðŸ”“ Unlock Universal Architecture" æ­¥éª¤
      # è¿™æ ·å°±ä¼šç›´æŽ¥ä½¿ç”¨ä½  build.gradle é‡ŒåŽŸæœ¬çš„é…ç½® (ndk { abiFilters "arm64-v8a" })

      - name: ðŸ§¶ Install Dependencies
        run: flutter pub get

      - name: ðŸ” Verify Flutter Setup
        run: flutter doctor -v

      - name: ðŸ—ï¸ Build APK (Release - ARM64 Only)
        run: |
          echo "::notice title=Build Started::Building release APK for Android (ARM64)..."

          # ðŸ‘‡ æ˜¾å¼æŒ‡å®šåªæž„å»º android-arm64
          flutter build apk --release --target-platform android-arm64

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(ls -lh "$APK_PATH" | awk '{print $5}')
            echo "::notice title=Build Success::APK built successfully! Size: $APK_SIZE"
            echo "âœ… APK location: $APK_PATH"
          else
            echo "::error title=Build Failed::APK file not found!"
            exit 1
          fi

      - name: ðŸ“ Rename APK File
        id: rename-apk
        run: |
          echo "::group::ðŸ“ Renaming APK File"

          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/.*+//')

          if [ -z "$BUILD_NUMBER" ]; then BUILD_NUMBER="1"; fi
          if [ -z "$VERSION" ]; then echo "ðŸ˜¡ Failed to extract version"; exit 1; fi

          # ðŸ‘‡ å‘½åæ”¹ä¸º android-arm64
          NEW_APK_NAME="rwkv_chat_${VERSION}_${BUILD_NUMBER}_android-arm64.apk"
          OLD_APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          NEW_APK_PATH="build/app/outputs/flutter-apk/${NEW_APK_NAME}"

          mv "$OLD_APK_PATH" "$NEW_APK_PATH"

          echo "apk_path=${NEW_APK_PATH}" >> $GITHUB_OUTPUT
          echo "apk_name=${NEW_APK_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT

          echo "âœ… Renamed to: ${NEW_APK_NAME}"
          echo "::endgroup::"

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          files: ${{ steps.rename-apk.outputs.apk_path }}

      - name: ðŸŽ‰ Build Summary
        if: success()
        run: |
          echo "### âœ… Release Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.rename-apk.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ steps.rename-apk.outputs.apk_name }}\`" >> $GITHUB_STEP_SUMMARY
