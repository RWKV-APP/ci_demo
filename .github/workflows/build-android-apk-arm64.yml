name: Android apk arm64

run-name: ${{ github.ref_name }} Android apk arm64

on:
  push:
    tags:
      - '[0-9]*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-android-apk:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: false
          tool-cache: false
          dotnet: true
          haskell: true
          swap-storage: true
          docker-images: true
          large-packages: true

      - name: ðŸ“¥ Checkout main repo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Checkout rwkv_mobile_flutter dependency
        uses: actions/checkout@v4
        with:
          repository: MollySophia/rwkv_mobile_flutter
          ref: dev
          path: rwkv_mobile_flutter
          fetch-depth: 1

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: ðŸ“ Generate Config Files
        run: |
          echo "::group::ðŸ”§ Configuring Dependencies & Env"
          echo "dependency_overrides:" > pubspec_overrides.yaml
          echo "  rwkv_mobile_flutter:" >> pubspec_overrides.yaml
          echo "    path: ./rwkv_mobile_flutter" >> pubspec_overrides.yaml
          echo "âœ… pubspec_overrides.yaml created"
          echo "::endgroup::"

      # âŒ å·²åˆ é™¤ "ðŸ”“ Unlock Universal Architecture" æ­¥éª¤
      # è¿™æ ·å°±ä¼šç›´æŽ¥ä½¿ç”¨ä½  build.gradle é‡ŒåŽŸæœ¬çš„é…ç½® (ndk { abiFilters "arm64-v8a" })

      - name: ðŸ§¶ Install Dependencies
        run: flutter pub get

      - name: ðŸ” Verify Flutter Setup
        run: flutter doctor -v

      - name: ðŸ—ï¸ Build apk (Release - arm64 Only)
        run: |
          echo "::notice title=Build Started::Building release apk for Android (arm64)..."

          # ðŸ‘‡ æ˜¾å¼æŒ‡å®šåªæž„å»º android-arm64
          flutter build apk --release --target-platform android-arm64

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(ls -lh "$APK_PATH" | awk '{print $5}')
            echo "::notice title=Build Success::apk built successfully! Size: $APK_SIZE"
            echo "âœ… apk location: $APK_PATH"
          else
            echo "::error title=Build Failed::apk file not found!"
            exit 1
          fi

      - name: ðŸ” Sign APK with JKS
        run: |
          echo "::group::ðŸ” Signing APK"

          # 1. ä»Ž Secret æ¢å¤ JKS æ–‡ä»¶
          mkdir -p android/app
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
          chmod 600 android/app/keystore.jks

          # 2. æŸ¥æ‰¾ Android SDK è·¯å¾„
          ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          if [ -z "$ANDROID_SDK_ROOT" ]; then
            ANDROID_SDK_ROOT="$HOME/Library/Android/sdk"
          fi

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"

          # 3. å°è¯•ä½¿ç”¨ apksignerï¼ˆæŽ¨èæ–¹å¼ï¼Œæ”¯æŒ v1+v2 ç­¾åï¼‰
          APKSIGNER=$(find "$ANDROID_SDK_ROOT/build-tools" -name apksigner 2>/dev/null | head -n 1)

          if [ -n "$APKSIGNER" ]; then
            echo "âœ… Using apksigner for signing"
            $APKSIGNER sign \
              --ks android/app/keystore.jks \
              --ks-pass pass:"${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
              --key-pass pass:"${{ secrets.ANDROID_KEY_PASSWORD }}" \
              --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
              --out "${APK_PATH}.signed" \
              "$APK_PATH"
            
            mv "${APK_PATH}.signed" "$APK_PATH"
            
            # éªŒè¯ç­¾å
            $APKSIGNER verify "$APK_PATH" && echo "âœ… APK signed and verified successfully"
          else
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ jarsigner
            echo "âš ï¸ apksigner not found, using jarsigner instead"
            jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
              -keystore android/app/keystore.jks \
              -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
              -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}" \
              "$APK_PATH" \
              "${{ secrets.ANDROID_KEY_ALIAS }}"
            
            # å¯¹é½ APKï¼ˆzipalignï¼‰
            ZIPALIGN=$(find "$ANDROID_SDK_ROOT/build-tools" -name zipalign 2>/dev/null | head -n 1)
            if [ -n "$ZIPALIGN" ]; then
              mv "$APK_PATH" "${APK_PATH}.unsigned"
              $ZIPALIGN -v 4 "${APK_PATH}.unsigned" "$APK_PATH"
              rm "${APK_PATH}.unsigned"
            fi
            
            # éªŒè¯ç­¾å
            jarsigner -verify -verbose -certs "$APK_PATH" && echo "âœ… APK signed and verified successfully"
          fi

          # 4. æ¸…ç† JKS æ–‡ä»¶
          rm -f android/app/keystore.jks

          echo "::endgroup::"

      - name: ðŸ“ Rename apk File
        id: rename-apk
        run: |
          echo "::group::ðŸ“ Renaming apk File"

          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/.*+//')

          if [ -z "$BUILD_NUMBER" ]; then BUILD_NUMBER="1"; fi
          if [ -z "$VERSION" ]; then echo "ðŸ˜¡ Failed to extract version"; exit 1; fi

          # ðŸ‘‡ å‘½åæ”¹ä¸º android-arm64
          NEW_APK_NAME="rwkv_chat_${VERSION}_${BUILD_NUMBER}_android-arm64.apk"
          OLD_APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          NEW_APK_PATH="build/app/outputs/flutter-apk/${NEW_APK_NAME}"

          mv "$OLD_APK_PATH" "$NEW_APK_PATH"

          echo "apk_path=${NEW_APK_PATH}" >> $GITHUB_OUTPUT
          echo "apk_name=${NEW_APK_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT

          echo "âœ… Renamed to: ${NEW_APK_NAME}"
          echo "::endgroup::"

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: false
          files: ${{ steps.rename-apk.outputs.apk_path }}

      - name: ðŸ› ï¸ Install Tencent COSCMD
        if: startsWith(github.ref, 'refs/tags/')
        run: pip install coscmd

      - name: ðŸ“¤ Upload to Tencent COS
        if: startsWith(github.ref, 'refs/tags/')
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
          LOCAL_FILE: ${{ steps.rename-apk.outputs.apk_path }}
          REMOTE_FOLDER: releases/${{ steps.rename-apk.outputs.version }}/
        run: |
          echo "::group::ðŸ“¤ Uploading to Tencent COS"
          # é…ç½® coscmd
          coscmd config -a "$COS_SECRET_ID" -s "$COS_SECRET_KEY" -b "$COS_BUCKET" -r "$COS_REGION"
          # æ‰§è¡Œä¸Šä¼ 
          echo "Uploading $LOCAL_FILE to $REMOTE_FOLDER"
          coscmd upload "$LOCAL_FILE" "$REMOTE_FOLDER"
          echo "âœ… Upload completed"
          echo "::endgroup::"

      - name: ðŸŽ‰ Build Summary
        if: success()
        run: |
          echo "### âœ… Release Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.rename-apk.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ steps.rename-apk.outputs.apk_name }}\`" >> $GITHUB_STEP_SUMMARY
