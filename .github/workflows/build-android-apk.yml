name: Build and Release Android APK

# è¿è¡Œåç§°ç¤ºä¾‹: "1.0.1 Android .apk"
run-name: ${{ github.ref_name }} Android .apk

on:
  push:
    tags:
      - '[0-9]*' # ä»…åœ¨æ‰“ tag æ—¶è§¦å‘
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build-android-apk:
    runs-on: ubuntu-latest

    steps:
      # 1. æ¸…ç†ç©ºé—´ (æŽ¨èä¿ç•™ï¼Œé˜²æ­¢ç£ç›˜ä¸è¶³)
      - name: ðŸ§¹ Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: false
          tool-cache: false
          dotnet: true
          haskell: true
          swap-storage: true
          docker-images: true
          large-packages: true

      # 2. æ‹‰å–ä»£ç 
      - name: ðŸ“¥ Checkout main repo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Checkout rwkv_mobile_flutter dependency
        uses: actions/checkout@v4
        with:
          repository: MollySophia/rwkv_mobile_flutter
          ref: dev
          path: rwkv_mobile_flutter
          fetch-depth: 1

      # 3. çŽ¯å¢ƒå‡†å¤‡
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      # 4. ç”Ÿæˆé…ç½®æ–‡ä»¶
      - name: ðŸ“ Generate Config Files
        run: |
          echo "::group::ðŸ”§ Configuring Dependencies & Env"
          echo "dependency_overrides:" > pubspec_overrides.yaml
          echo "  rwkv_mobile_flutter:" >> pubspec_overrides.yaml
          echo "    path: ./rwkv_mobile_flutter" >> pubspec_overrides.yaml
          echo "âœ… pubspec_overrides.yaml created"
          echo "::endgroup::"

      # 5. å®‰è£…ä¾èµ–
      - name: ðŸ§¶ Install Dependencies
        run: flutter pub get

      # 6. éªŒè¯çŽ¯å¢ƒ
      - name: ðŸ” Verify Flutter Setup
        run: flutter doctor -v

      # 7. æž„å»º APK
      - name: ðŸ—ï¸ Build APK (Release)
        run: |
          echo "::notice title=Build Started::Building release APK for Android..."
          flutter build apk --release

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(ls -lh "$APK_PATH" | awk '{print $5}')
            echo "::notice title=Build Success::APK built successfully! Size: $APK_SIZE"
            echo "âœ… APK location: $APK_PATH"
          else
            echo "::error title=Build Failed::APK file not found!"
            exit 1
          fi

      # 8. é‡å‘½å APK æ–‡ä»¶ (ä¿ç•™è¿™ä¸ªï¼Œå› ä¸ºå¯¹ Release æ–‡ä»¶åå¾ˆé‡è¦)
      - name: ðŸ“ Rename APK File
        id: rename-apk
        run: |
          echo "::group::ðŸ“ Renaming APK File"

          # æå–ç‰ˆæœ¬ä¿¡æ¯
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/.*+//')

          if [ -z "$BUILD_NUMBER" ]; then BUILD_NUMBER="1"; fi
          if [ -z "$VERSION" ]; then echo "ðŸ˜¡ Failed to extract version"; exit 1; fi

          # é‡å‘½å
          NEW_APK_NAME="rwkv_chat_${VERSION}_${BUILD_NUMBER}.apk"
          OLD_APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          NEW_APK_PATH="build/app/outputs/flutter-apk/${NEW_APK_NAME}"

          mv "$OLD_APK_PATH" "$NEW_APK_PATH"

          echo "apk_path=${NEW_APK_PATH}" >> $GITHUB_OUTPUT
          echo "apk_name=${NEW_APK_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT

          echo "âœ… Renamed to: ${NEW_APK_NAME}"
          echo "::endgroup::"

      # 9. å‘å¸ƒåˆ° GitHub Release
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          files: ${{ steps.rename-apk.outputs.apk_path }}

      # 10. æ‘˜è¦
      - name: ðŸŽ‰ Build Summary
        if: success()
        run: |
          echo "### âœ… Release Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.rename-apk.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ steps.rename-apk.outputs.apk_name }}\`" >> $GITHUB_STEP_SUMMARY
