name: Build and Release Android APK

run-name: ${{ github.ref_name }} Android .apk

on:
  push:
    # åªæœ‰å½“ä½ æ‰“çš„ tag æ˜¯ä»¥æ•°å­—å¼€å¤´æ—¶ï¼ˆå¦‚ 1.0.0, 1.1.0ï¼‰æ‰è§¦å‘è¿™ä¸ªæµç¨‹
    tags:
      - '[0-9]*'
  # ä¹Ÿå¯ä»¥ä¿ç•™æ‰‹åŠ¨è§¦å‘æ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

# å¿…é¡»åŠ ä¸Šè¿™ä¸ªæƒé™å£°æ˜Žï¼Œå¦åˆ™ Action æ²¡æ³•åˆ›å»º Release
permissions:
  contents: write
  actions: write

jobs:
  build-android-apk:
    runs-on: ubuntu-latest

    steps:
      # 1. æ¸…ç†ç©ºé—´
      - name: ðŸ§¹ Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: false
          tool-cache: false
          dotnet: true
          haskell: true
          swap-storage: true
          docker-images: true
          large-packages: true

      # 2. æ›´æ–°è¿è¡Œåç§°
      - name: ðŸ·ï¸ Update Run Name
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ github.ref_name }}';
            const system = 'Android';
            const file = '.apk';
            // èŽ·å–å½“å‰æ—¶é—´ï¼ˆä¸œå…«åŒºï¼‰
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
              timeZone: 'Asia/Shanghai',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            });
            const parts = formatter.formatToParts(now);
            const month = parts.find(p => p.type === 'month').value;
            const day = parts.find(p => p.type === 'day').value;
            const hour = parts.find(p => p.type === 'hour').value;
            const minute = parts.find(p => p.type === 'minute').value;
            const dateTime = `${month}.${day} ${hour}:${minute}`;
            const runName = `${version} ${system} ${file} ${dateTime}`;

            await github.rest.actions.updateWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
              name: runName
            });

            console.log(`âœ… Updated run name to: ${runName}`);

      # 3. æ‹‰å–ä»£ç 
      - name: ðŸ“¥ Checkout main repo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Checkout rwkv_mobile_flutter dependency
        uses: actions/checkout@v4
        with:
          repository: MollySophia/rwkv_mobile_flutter
          ref: dev
          path: rwkv_mobile_flutter
          fetch-depth: 1

      # 4. çŽ¯å¢ƒå‡†å¤‡ (Java + Flutter)
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      # 5. ç”Ÿæˆé…ç½®æ–‡ä»¶
      - name: ðŸ“ Generate Config Files
        run: |
          echo "::group::ðŸ”§ Configuring Dependencies & Env"

          # Override Path
          echo "dependency_overrides:" > pubspec_overrides.yaml
          echo "  rwkv_mobile_flutter:" >> pubspec_overrides.yaml
          echo "    path: ./rwkv_mobile_flutter" >> pubspec_overrides.yaml
          echo "âœ… pubspec_overrides.yaml created"

          echo "::endgroup::"

      # 6. å®‰è£…ä¾èµ–
      - name: ðŸ§¶ Install Dependencies
        run: flutter pub get

      # 7. éªŒè¯ Flutter çŽ¯å¢ƒ
      - name: ðŸ” Verify Flutter Setup
        run: |
          echo "::group::ðŸ” Flutter Environment"
          flutter doctor -v
          echo "::endgroup::"

      # 8. æž„å»º APK
      - name: ðŸ—ï¸ Build APK (Release)
        run: |
          echo "::notice title=Build Started::Building release APK for Android..."
          flutter build apk --release

          # æ˜¾ç¤ºæž„å»ºç»“æžœ
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(ls -lh "$APK_PATH" | awk '{print $5}')
            echo "::notice title=Build Success::APK built successfully! Size: $APK_SIZE"
            echo "âœ… APK location: $APK_PATH"
          else
            echo "ðŸ˜¡ APK file not found!"
            echo "::error title=Build Failed::APK file not found!"
            exit 1
          fi

      # 9. é‡å‘½å APK æ–‡ä»¶
      - name: ðŸ“ Rename APK File
        id: rename-apk
        run: |
          echo "::group::ðŸ“ Renaming APK File"

          # ä»Ž pubspec.yaml ä¸­æå–ç‰ˆæœ¬å·å’Œæž„å»ºå·
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/.*+//')

          # å¦‚æžœæ²¡æœ‰æž„å»ºå·ï¼Œä½¿ç”¨é»˜è®¤å€¼
          if [ -z "$BUILD_NUMBER" ]; then
            BUILD_NUMBER="1"
            echo "ðŸš§ Build number not found, using default: 1"
          fi

          # éªŒè¯ç‰ˆæœ¬å·æ˜¯å¦æå–æˆåŠŸ
          if [ -z "$VERSION" ]; then
            echo "ðŸ˜¡ Failed to extract version from pubspec.yaml"
            exit 1
          fi

          # ç”Ÿæˆæ–°æ–‡ä»¶åï¼šrwkv_chat_ç‰ˆæœ¬å·_æž„å»ºå·.apk
          NEW_APK_NAME="rwkv_chat_${VERSION}_${BUILD_NUMBER}.apk"
          OLD_APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          NEW_APK_PATH="build/app/outputs/flutter-apk/${NEW_APK_NAME}"

          # æ£€æŸ¥åŽŸæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$OLD_APK_PATH" ]; then
            echo "ðŸ˜¡ Original APK file not found: $OLD_APK_PATH"
            exit 1
          fi

          # é‡å‘½åæ–‡ä»¶
          mv "$OLD_APK_PATH" "$NEW_APK_PATH"

          # éªŒè¯é‡å‘½åæ˜¯å¦æˆåŠŸ
          if [ ! -f "$NEW_APK_PATH" ]; then
            echo "ðŸ˜¡ Failed to rename APK file"
            exit 1
          fi

          # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "apk_path=${NEW_APK_PATH}" >> $GITHUB_OUTPUT
          echo "apk_name=${NEW_APK_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT

          # æ˜¾ç¤ºä¿¡æ¯
          echo "âœ… APK renamed to: ${NEW_APK_NAME}"
          echo "ðŸ“¦ Version: ${VERSION}"
          echo "ðŸ”¢ Build Number: ${BUILD_NUMBER}"

          echo "::endgroup::"

      # 10. åˆ›å»º GitHub Release å¹¶ä¸Šä¼  APK
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # è‡ªåŠ¨æŠŠ Release Notes å¡«æˆ Git çš„æäº¤è®°å½•
          generate_release_notes: true
          # æŠŠç¼–è¯‘å¥½çš„ APK ä¸Šä¼ ä¸ŠåŽ»ï¼ˆä½¿ç”¨é‡å‘½ååŽçš„æ–‡ä»¶ï¼‰
          files: ${{ steps.rename-apk.outputs.apk_path }}

      # 11. ç”Ÿæˆæž„å»ºæ‘˜è¦
      - name: ðŸŽ‰ Build Summary
        if: success()
        run: |
          APK_PATH="${{ steps.rename-apk.outputs.apk_path }}"
          APK_NAME="${{ steps.rename-apk.outputs.apk_name }}"
          VERSION="${{ steps.rename-apk.outputs.version }}"
          BUILD_NUMBER="${{ steps.rename-apk.outputs.build_number }}"

          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(ls -lh "$APK_PATH" | awk '{print $5}')
          else
            APK_SIZE="N/A"
          fi

          echo "### âœ… Release Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** Release" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${BUILD_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "**File Name:** \`${APK_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`${APK_PATH}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${APK_SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "âœ… APK has been uploaded to GitHub Release as \`${APK_NAME}\`" >> $GITHUB_STEP_SUMMARY
          fi
