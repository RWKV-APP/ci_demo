name: Build and Release Linux ARM64

run-name: ${{ github.ref_name }} Linux ARM64

on:
  push:
    tags:
      - '[0-9]*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-linux-arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout rwkv_mobile_flutter dependency
        uses: actions/checkout@v4
        with:
          repository: MollySophia/rwkv_mobile_flutter
          ref: dev
          path: rwkv_mobile_flutter
          fetch-depth: 1

      # âŒ åˆ é™¤äº†æ™®é€šçš„ Setup Flutterï¼Œæ”¹ç”¨ä¸‹é¢çš„ QEMU æ¨¡æ‹Ÿå™¨

      # ğŸ‘‡ æ ¸å¿ƒæ­¥éª¤ï¼šå¯åŠ¨ ARM64 æ¨¡æ‹Ÿå™¨ç¯å¢ƒè¿›è¡Œæ„å»º
      - name: ğŸ—ï¸ Build in ARM64 Emulator
        uses: uraimo/run-on-arch-action@v2
        id: build
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}

          # 1. åœ¨å®¹å™¨å†…å®‰è£… ARM64 ä¾èµ– (æ³¨æ„ï¼šè¿™é‡Œå®‰è£…çš„æ˜¯çœŸæ­£çš„ arm64 åº“)
          install: |
            apt-get update -q -y
            apt-get install -q -y \
              git curl unzip xz-utils \
              clang cmake ninja-build pkg-config \
              libgtk-3-dev liblzma-dev

          # 2. è¿è¡Œæ„å»ºè„šæœ¬
          run: |
            # --- å®‰è£… Flutter (ARM64 ç‰ˆæœ¬) ---
            echo "â¬‡ï¸ Downloading Flutter (ARM64)..."
            git clone https://github.com/flutter/flutter.git --depth 1 -b stable /opt/flutter
            export PATH="/opt/flutter/bin:$PATH"

            # è§£å†³ Git å®‰å…¨ç›®å½•é—®é¢˜
            git config --global --add safe.directory "*"

            # --- é…ç½®ä¾èµ–è¦†ç›– ---
            echo "ğŸ”§ Configuring overrides..."
            echo "dependency_overrides:" > pubspec_overrides.yaml
            echo "  rwkv_mobile_flutter:" >> pubspec_overrides.yaml
            echo "    path: ./rwkv_mobile_flutter" >> pubspec_overrides.yaml

            # --- å®‰è£…ä¾èµ–å¹¶æ„å»º ---
            echo "ğŸ§¶ Pub get..."
            flutter pub get

            echo "ğŸ—ï¸ Building Linux ARM64..."
            # åœ¨ ARM64 ç¯å¢ƒä¸‹ï¼Œä¸éœ€è¦ --target-platform å‚æ•°ï¼Œç›´æ¥ build å°±æ˜¯ arm64
            flutter build linux --release

            # --- æ‰“åŒ…å’Œé‡å‘½å ---
            echo "ğŸ“¦ Packaging..."

            # æå–ç‰ˆæœ¬å·
            VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
            BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/.*+//')
            if [ -z "$BUILD_NUMBER" ]; then BUILD_NUMBER="1"; fi

            # å‘½åæ ¼å¼
            ARCHIVE_NAME="rwkv_chat_${VERSION}_${BUILD_NUMBER}_linux-arm64.tar.gz"

            # è¿›å…¥æ„å»ºç›®å½• (æ³¨æ„: è¿™é‡Œçš„è·¯å¾„é€šå¸¸åŒ…å« arm64)
            cd build/linux/arm64/release/bundle
            tar -czf "$ARCHIVE_NAME" *

            # æŠŠæ‰“å¥½çš„åŒ…ç§»åŠ¨åˆ°å¤–å±‚ï¼Œæ–¹ä¾¿ Host æœºå™¨è¯»å–
            mv "$ARCHIVE_NAME" /artifacts/

            # å°†å˜é‡å†™å…¥æ–‡ä»¶ä¾› Host è¯»å–
            echo "archive_name=$ARCHIVE_NAME" > /artifacts/build_vars.env
            echo "version=$VERSION" >> /artifacts/build_vars.env

          # 3. æŒ‚è½½ç›®å½•æ˜ å°„
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
            --volume "${PWD}:/artifacts" 
            --workdir "/workspace"

      # ğŸ‘‡ ä»æ¨¡æ‹Ÿå™¨è¾“å‡ºä¸­æ¢å¤å˜é‡å’Œæ–‡ä»¶è·¯å¾„
      - name: ğŸ“¤ Export Output Variables
        id: export-vars
        run: |
          # è¯»å–å®¹å™¨ç”Ÿæˆçš„å˜é‡æ–‡ä»¶
          cat build_vars.env >> $GITHUB_OUTPUT

          # æ„é€ å®Œæ•´è·¯å¾„
          ARCHIVE_NAME=$(grep "archive_name=" build_vars.env | cut -d= -f2)
          echo "archive_path=$(pwd)/$ARCHIVE_NAME" >> $GITHUB_OUTPUT

          echo "âœ… Retrieved artifact: $ARCHIVE_NAME"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # âœ… ä¸ç”Ÿæˆæ—¥å¿—
          generate_release_notes: false
          files: ${{ steps.export-vars.outputs.archive_path }}
