name: macOS .dmg universal

run-name: ${{ github.ref_name }} macOS .dmg universal + Notarization

on:
  push:
    tags:
      - '[0-9]*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-macos-dmg:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout rwkv_mobile_flutter dependency
        uses: actions/checkout@v4
        with:
          repository: MollySophia/rwkv_mobile_flutter
          ref: dev
          path: rwkv_mobile_flutter
          fetch-depth: 1

      # æ›¿æ¢åŸæ¥çš„ Import æ­¥éª¤
      - name: ğŸ” Import Code-Signing Certificates
        env:
          CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # 1. å®šä¹‰ä¸´æ—¶é’¥åŒ™ä¸²è·¯å¾„ (ä½¿ç”¨ RUNNER_TEMP æ›´å®‰å…¨)
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # 2. åˆ›å»ºå¹¶è§£é”æ–°é’¥åŒ™ä¸²
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"

          # 3. ã€å…³é”®ä¿®å¤ã€‘å°†æ–°é’¥åŒ™ä¸²åŠ å…¥ç³»ç»Ÿæœç´¢åˆ—è¡¨
          # å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œcodesign å¯èƒ½æ‰¾ä¸åˆ°è¯ä¹¦
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          # 4. å¯¼å…¥è¯ä¹¦
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN_PATH" -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign

          # 5. æˆæƒ codesign è®¿é—®ï¼ˆé˜²æ­¢å¼¹çª—å¡æ­»ï¼‰
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" "$KEYCHAIN_PATH"

          # 6. ã€è°ƒè¯•ã€‘æ‰“å°æ‰€æœ‰å¯ç”¨è¯ä¹¦
          # è¯·åœ¨è¿è¡Œå¤±è´¥åæŸ¥çœ‹è¿™ä¸€æ­¥çš„è¾“å‡ºï¼š
          # å¦‚æœæ˜¾ç¤º "0 valid identities found"ï¼Œè¯´æ˜ä½ çš„ P12 æ–‡ä»¶é‡Œæ²¡æœ‰ç§é’¥ï¼Œå¿…é¡»é‡æ–°å¯¼å‡ºï¼
          echo "ğŸ‘‡ Listing identities in keychain:"
          security find-identity -v -p codesigning

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: Override dependency path
        run: |
          echo "dependency_overrides:" > pubspec_overrides.yaml
          echo "  rwkv_mobile_flutter:" >> pubspec_overrides.yaml
          echo "    path: ./rwkv_mobile_flutter" >> pubspec_overrides.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS app (Universal)
        run: flutter build macos --release

      # ----------------------------------------------------------------
      # 2. ç­¾å .app æ–‡ä»¶ (æ–°å¢æ­¥éª¤)
      # æ³¨æ„ï¼šå¿…é¡»åœ¨æ‰“åŒ… DMG ä¹‹å‰å¯¹ .app è¿›è¡Œç­¾å
      # ----------------------------------------------------------------
      - name: âœï¸ Sign App Bundle
        run: |
          # å®šä¹‰ App è·¯å¾„
          APP_PATH="build/macos/Build/Products/Release/ci_demo.app"

          # å®šä¹‰ä½ çš„è¯ä¹¦èº«ä»½ (ä»ä½ æä¾›çš„è¯ä¹¦ä¿¡æ¯ä¸­è·å–)
          IDENTITY="Developer ID Application: Shenzhen Yuanshi Intelligence Co., Ltd. (3FTQ9PH6TL)"

          echo "Signing $APP_PATH with identity: $IDENTITY"

          # æ‰§è¡Œç­¾å (å¼€å¯ Hardened Runtimeï¼Œè¿™æ˜¯å…¬è¯å¿…é¡»çš„)
          codesign --deep --force --verbose --options runtime --timestamp --sign "$IDENTITY" "$APP_PATH"

          # éªŒè¯ç­¾å
          codesign --verify --verbose "$APP_PATH"

      # ----------------------------------------------------------------
      # 3. åˆ›å»ºå¹¶ç­¾å DMG (ä¿®æ”¹æ­¥éª¤)
      # DMG ä¹Ÿéœ€è¦ç­¾åï¼Œå¦åˆ™å…¬è¯æ—¶å¯èƒ½ä¼šè­¦å‘Š
      # ----------------------------------------------------------------
      - name: ğŸ“¦ Create and Sign DMG
        id: create-dmg
        run: |
          echo "::group::ğŸ“¦ Creating dmg"

          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/.*+//')
          if [ -z "$BUILD_NUMBER" ]; then BUILD_NUMBER="1"; fi

          DMG_NAME="rwkv_chat_${VERSION}_${BUILD_NUMBER}_macos-universal.dmg"

          # è¿›å…¥ Release ç›®å½•
          cd build/macos/Build/Products/Release

          # åˆ›å»º DMG
          hdiutil create -volname "RWKV_Chat" -srcfolder "ci_demo.app" -ov -format UDZO "$DMG_NAME"

          # âœ… ç­¾å DMG æ–‡ä»¶
          IDENTITY="Developer ID Application: Shenzhen Yuanshi Intelligence Co., Ltd. (3FTQ9PH6TL)"
          echo "Signing DMG..."
          codesign --force --sign "$IDENTITY" "$DMG_NAME"

          DMG_PATH="$(pwd)/$DMG_NAME"

          echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT
          echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "âœ… dmg created and signed: $DMG_NAME"
          echo "::endgroup::"

      # ----------------------------------------------------------------
      # 4. æäº¤å…¬è¯ (Notarization) (æ–°å¢æ­¥éª¤)
      # åªæœ‰å…¬è¯é€šè¿‡ï¼ŒmacOS æ‰èƒ½åœ¨ä¸ä¿®æ”¹å®‰å…¨è®¾ç½®çš„æƒ…å†µä¸‹æ‰“å¼€ä½ çš„ App
      # ----------------------------------------------------------------
      - name: ğŸ›¡ï¸ Notarize Software
        env:
          # Apple ID è´¦å·
          APPLE_ID: ${{ secrets.APPLE_ID_EMAIL }}
          # App ä¸“ç”¨å¯†ç 
          APP_PASSWORD: ${{ secrets.MACOS_APP_PASSWORD }}
          # Team ID
          TEAM_ID: ${{ secrets.MACOS_IDENTITY_ID }}
          # è¦å…¬è¯çš„æ–‡ä»¶
          FILE_PATH: ${{ steps.create-dmg.outputs.dmg_path }}
        run: |
          echo "::group::ğŸ›¡ï¸ Notarizing..."

          xcrun notarytool submit "$FILE_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APP_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait

          echo "âœ… Notarization request submitted and approved."
          echo "::endgroup::"

      # ----------------------------------------------------------------
      # 5. è£…è®¢å…¬è¯ç¥¨æ® (Staple) (æ–°å¢æ­¥éª¤)
      # è®©ç”¨æˆ·ç¦»çº¿æ—¶ä¹Ÿèƒ½éªŒè¯å…¬è¯çŠ¶æ€
      # ----------------------------------------------------------------
      - name: ğŸ“ Staple Ticket
        run: |
          xcrun stapler staple "${{ steps.create-dmg.outputs.dmg_path }}"
          echo "âœ… Stapled notarization ticket to DMG."

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: false
          files: ${{ steps.create-dmg.outputs.dmg_path }}

      - name: ğŸ› ï¸ Setup Python
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        if: startsWith(github.ref, 'refs/tags/')
        run: pip install huggingface_hub

      - name: ğŸ“¤ Upload to HuggingFace
        if: startsWith(github.ref, 'refs/tags/')
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_ENDPOINT: ${{ secrets.HF_ENDPOINT || 'https://huggingface.co' }}
          HF_REPO_ID: ${{ secrets.HF_REPO_ID || 'rwkv-app/ci-demo-releases' }}
        run: |
          echo "::group::ğŸ“¤ Uploading to HuggingFace"
          python scripts/upload_to_hf.py \
            --repo-id "$HF_REPO_ID" \
            --file "${{ steps.create-dmg.outputs.dmg_path }}" \
            --path-in-repo "macos-universal/${{ steps.create-dmg.outputs.dmg_name }}" \
            --hf-token "$HF_TOKEN" \
            --hf-endpoint "$HF_ENDPOINT"
          echo "âœ… Upload completed"
          echo "::endgroup::"
