name: Test HF Upload

run-name: ${{ github.ref_name }} Test HF Upload

on:
  push:
    tags:
      - '[0-9]*' # ä»…åœ¨æ‰“ tag æ—¶è§¦å‘
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  test-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: pip install huggingface_hub

      - name: ðŸ“ Create test file
        id: create-test-file
        run: |
          echo "::group::ðŸ“ Creating test file"
          # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          TEST_FILE="test_file_${TIMESTAMP}.txt"

          # åˆ›å»ºæµ‹è¯•æ–‡ä»¶å†…å®¹
          echo "This is a test file uploaded at $(date)" > "$TEST_FILE"
          echo "Timestamp: $TIMESTAMP" >> "$TEST_FILE"
          echo "GitHub Run ID: ${{ github.run_id }}" >> "$TEST_FILE"
          echo "GitHub Run Number: ${{ github.run_number }}" >> "$TEST_FILE"

          echo "test_file=$TEST_FILE" >> $GITHUB_OUTPUT
          echo "âœ… Created test file: $TEST_FILE"
          echo "::endgroup::"

      - name: ðŸ“¤ Upload to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_ENDPOINT: ${{ secrets.HF_ENDPOINT || 'https://huggingface.co' }}
          HF_REPO_ID: ${{ secrets.HF_REPO_ID || 'rwkv-app/ci-demo-releases' }}
        run: |
          echo "::group::ðŸ“¤ Uploading to HuggingFace"
          python scripts/upload_to_hf.py \
            --repo-id "$HF_REPO_ID" \
            --file "${{ steps.create-test-file.outputs.test_file }}" \
            --path-in-repo "test-files/${{ steps.create-test-file.outputs.test_file }}" \
            --hf-token "$HF_TOKEN" \
            --hf-endpoint "$HF_ENDPOINT"
          echo "âœ… Upload completed"
          echo "::endgroup::"

      - name: ðŸ“‹ Upload Summary
        if: success()
        run: |
          echo "### âœ… Test Upload Successful" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ steps.create-test-file.outputs.test_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ secrets.HF_REPO_ID || 'rwkv-app/ci-demo-releases' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Path in repo:** \`test-files/${{ steps.create-test-file.outputs.test_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Uploaded at:** $(date)" >> $GITHUB_STEP_SUMMARY
